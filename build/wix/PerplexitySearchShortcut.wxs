<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?define ProductName="PowerToys Run Perplexity Search Plugin" ?>
  <?define Manufacturer="0x6f677548" ?>
  
  <Product Id="*" 
           Name="$(var.ProductName)" 
           Language="1033" 
           Version="$(var.Version)" 
           Manufacturer="$(var.Manufacturer)" 
           UpgradeCode="B66EA7F1-CF0E-4541-8C79-D248FC7B889F">
    
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" />
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of $(var.ProductName) is already installed." />
    <MediaTemplate EmbedCab="yes" />
    
    <Feature Id="ProductFeature" Title="Perplexity Search Plugin" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ImageComponents" />
    </Feature>
    
    <UIRef Id="WixUI_Minimal" />
  </Product>
  
  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <Directory Id="MicrosoftDir" Name="Microsoft">
          <Directory Id="PowerToysDir" Name="PowerToys">
            <Directory Id="PowerToysRunDir" Name="PowerToys Run">
              <Directory Id="PluginsDir" Name="Plugins">
                <Directory Id="PerplexityPluginDir" Name="PerplexitySearchShortcut">
                  <Directory Id="ImagesDir" Name="Images" />
                </Directory>
              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>
  </Fragment>
  
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="PerplexityPluginDir">
      <!-- Main plugin DLL -->
      <Component Id="PluginDll" Guid="*">
        <File Id="PluginDllFile" 
              Name="$(var.PluginDllName)" 
              Source="$(var.SourceDir)$(var.PluginDllName)" 
              KeyPath="yes" />
              
        <RemoveFolder Id="RemovePerplexityPluginDir" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\0x6f677548\PowerToysRunPerplexityPlugin" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" />
      </Component>
      
      <!-- Plugin JSON file -->
      <Component Id="PluginJson" Guid="*">
        <File Id="PluginJsonFile" 
              Name="$(var.PluginJsonName)" 
              Source="$(var.SourceDir)$(var.PluginJsonName)" 
              KeyPath="yes" />
      </Component>
      
      <!-- Dependencies JSON file - now mandatory -->
      <Component Id="PluginDepsJson" Guid="*">
        <File Id="PluginDepsJsonFile" 
              Name="$(var.PluginDepsJsonName)"
              Source="$(var.SourceDir)$(var.PluginDepsJsonName)"
              KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <ComponentGroup Id="ImageComponents" Directory="ImagesDir">
      <!-- Images folder with Heat autogeneration comment -->
      <!-- If using a Heat tool, replace this component with autogenerated components -->
      <Component Id="ImagesFolder" Guid="*">
        <CreateFolder />
        <RemoveFolder Id="RemoveImagesDir" On="uninstall" />
        <RegistryValue Root="HKCU" 
                       Key="Software\0x6f677548\PowerToysRunPerplexityPlugin\Images" 
                       Name="installed" 
                       Type="integer" 
                       Value="1" 
                       KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
